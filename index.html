<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水資源永續挑戰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 基本設定 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden;
            background-color: #0b132b;
        }

        /* --- 背景層 --- */
        .background-gradient {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(-45deg, #0b132b, #1c2541, #3a506b, #5bc0be);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: 1;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
        }

        /* --- 內容層 --- */
        .screen {
            width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center; text-align: center; color: #ffffff;
            position: absolute; top: 0; left: 0;
            opacity: 0; visibility: hidden;
            transition: opacity 0.8s ease, visibility 0.8s ease;
            z-index: 3;
        }
        .screen.active { opacity: 1; visibility: visible; }
        #home-screen { flex-direction: column; }
        .logo {
            width: 180px; height: 180px; margin-bottom: 2rem;
            animation: float 4s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(91, 192, 190, 0.5));
            border-radius: 50%; object-fit: cover;
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0px); } }
        
        h1 { font-size: 2.8rem; text-shadow: 0 0 10px rgba(0, 0, 0, 0.5); margin-bottom: 1rem; font-weight: 700; }
        p.subtitle { font-size: 1.2rem; color: #cdd4e4; margin-bottom: 2.5rem; }

        .start-button {
            background-color: #5bc0be; color: #0b132b; border: none; padding: 15px 40px;
            font-size: 1.2rem; font-weight: 700; border-radius: 50px; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(91, 192, 190, 0.3); letter-spacing: 1px;
        }
        .start-button:hover { transform: translateY(-4px) scale(1.05); box-shadow: 0 8px 25px rgba(91, 192, 190, 0.5); }
        
        #tutorial-screen {
            background-color: #f0f2f5; 
        }
        #tutorial-bg-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        
        .next-page-button {
            position: fixed; bottom: 30px; right: 30px; background-color: #e67e22; color: white;
            padding: 12px 25px; border-radius: 50px; text-decoration: none; font-size: 1.1rem;
            font-weight: 500; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); transition: all 0.3s ease;
            z-index: 1000;
        }
        .next-page-button:hover { background-color: #d35400; transform: scale(1.05); }

        /* --- 教學引導層樣式 --- */
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1500;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #tutorial-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #tutorial-highlight {
            position: absolute;
            border: 3px solid #e74c3c;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(11, 19, 43, 0.85);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #tutorial-text {
            position: absolute;
            background-color: rgba(44, 62, 80, 0.95);
            color: #ecf0f1;
            padding: 20px 25px;
            border-radius: 10px;
            border: 1px solid #7f8c8d;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            line-height: 1.7;
            font-size: 1.1rem;
        }
        #tutorial-text h3 {
            margin: 0 0 10px 0;
            color: #5bc0be;
            font-size: 1.4rem;
        }
        #tutorial-text p {
            margin: 0 0 15px 0;
        }
        #tutorial-text small {
            color: #bdc3c7;
            font-style: italic;
        }
        .text-highlight {
            background-color: #f39c12;
            color: #0b132b;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2.2rem; }
            p.subtitle { font-size: 1rem; }
            .logo { width: 140px; height: 140px; }
            .start-button { padding: 12px 30px; font-size: 1rem;}
            .next-page-button { bottom: 20px; right: 20px; padding: 10px 20px; font-size: 1rem;}
            #tutorial-text { font-size: 1rem; padding: 15px 20px;}
            #tutorial-text h3 { font-size: 1.2rem; }

            #welcome-statement > div {
                padding: 20px !important;
            }
            #welcome-statement h2 {
                font-size: 1.5em !important;
            }
            #welcome-statement p, #welcome-statement ol {
                font-size: 1em !important;
                line-height: 1.6 !important;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            #welcome-statement {
                padding: 25px !important;
            }
            #welcome-statement > div {
                padding: 15px 10px !important;
            }
            #welcome-statement h2 {
                font-size: 1.2em !important;
            }
            #welcome-statement p, #welcome-statement ol {
                font-size: 0.85em !important;
            }
            #welcome-statement ol {
                padding-left: 20px !important;
            }
            #welcome-statement button {
                padding: 10px 20px !important;
                font-size: 0.9em !important;
            }
            #tutorial-text { font-size: 0.9rem; padding: 10px 15px; }
            #tutorial-text h3 { font-size: 0.8rem; }
        }

        #rotate-prompt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(11, 19, 43, 0.98);
            color: white;
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.2rem;
            padding: 20px;
            box-sizing: border-box;
        }

        @media (max-width: 1024px) and (orientation: portrait) {
            body.tutorial-active #rotate-prompt-overlay {
                display: flex;
            }
        }
    </style>
</head>
<body>

    <div id="rotate-prompt-overlay">
        <p>為了獲得最佳體驗，請將您的裝置轉為橫向模式。</p>
    </div>

    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(11, 19, 43, 0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; text-align: left; color: #ecf0f1; padding: 20px; box-sizing: border-box;" id="welcome-statement">
        <div style="max-width: 800px; background-color: #1c2541; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); border: 1px solid #3a506b;">
            <h2 style="color: #5bc0be; font-size: 1.8em; margin-top: 0; text-align: center;">歡迎參與「數位平台設計對乾旱風險感知」學術研究</h2>
            <p style="font-size: 1.1em; line-height: 1.7;">您好！感謝您撥冗參與本次研究。本研究旨在探討數位共創平台的設計（如資訊呈現、互動方式）如何影響使用者對於乾旱風險的感知、對相關政策的認同，以及調高水費來因應乾旱的意願。</p>
            <p style="font-size: 1.1em; line-height: 1.7;">在接下來的體驗中，您將會依序完成以下三個環節：</p>
            <ol style="font-size: 1.1em; line-height: 1.8; padding-left: 25px;">
                <li><strong>前導教學：</strong>首先，我們會引導您熟悉水利署防災資訊網的操作，學習如何查詢即時的水庫水情資訊。</li>
                <li><strong>情境模擬挑戰：</strong>接著，您將進入一個「乾旱風險情境模擬器」。在此互動遊戲中，您的每個決策都將影響虛擬社區的水庫存量與您的節水積分。</li>
                <li><strong>研究問卷填寫：</strong>完成模擬挑戰後，系統將引導您填寫一份學術問卷，以收集您對於本次體驗的回饋與看法。</li>
            </ol>
            <p style="font-size: 1.1em; line-height: 1.7;">本問卷採匿名方式進行，所有資料僅供學術分析之用，請您放心填答。您的寶貴意見將是本研究成功的關鍵，並有助於未來開發更有效的數位溝通平台。</p>
            <div style="text-align: center; margin-top: 25px;">
                <button onclick="document.getElementById('welcome-statement').style.display='none';" style="background-color: #e67e22; color: white; border: none; padding: 12px 30px; font-size: 1.1em; font-weight: 700; border-radius: 50px; cursor: pointer; transition: all 0.3s ease;">我已了解，開始體驗</button>
            </div>
        </div>
    </div>

    <!-- 背景層 -->
    <div class="background-gradient"></div>
    <canvas id="particle-canvas"></canvas>

    <!-- 內容層 -->
    <div id="home-screen" class="screen active">
        <img src="dry-logo.png" alt="水資源 Logo" class="logo">
        <h1>第一階段：水資源永續挑戰</h1>
        <p class="subtitle">了解水情，學習節水，應對未來的乾旱風險</p>
        <button id="start-btn" class="start-button">開始挑戰</button>
    </div>

    <!-- 教學引導畫面 -->
    <div id="tutorial-screen" class="screen">
        <img id="tutorial-bg-img" src="" alt="防災資訊網教學背景">
        <iframe id="external-site-iframe" style="width:100%; height:100%; border:none; position:absolute; top:0; left:0; z-index: 5;"></iframe>
        <a href="drought_simulator.html" class="next-page-button">下一頁 &raquo;</a>
    </div>

    <!-- 教學引導層 -->
    <div id="tutorial-overlay">
        <div id="tutorial-highlight"></div>
        <div id="tutorial-text"></div>
    </div>

    <script>
        // --- 粒子動畫邏輯 (保持不變) ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;
        class Particle{constructor(t,e,i,o,s,a){this.x=t,this.y=e,this.directionX=i,this.directionY=o,this.size=s,this.color=a}draw(){ctx.beginPath(),ctx.arc(this.x,this.y,this.size,0,2*Math.PI,!1),ctx.fillStyle=this.color,ctx.fill()}update(){this.x>canvas.width||this.x<0?this.directionX=-this.directionX:void 0,this.y>canvas.height||this.y<0?this.directionY=-this.directionY:void 0,this.x+=this.directionX,this.y+=this.directionY,this.draw()}}
        function init(){particlesArray=[];const t=(canvas.height*canvas.width)/9e3;for(let e=0;e<t;e++){const t=2*Math.random()+1,i=Math.random()*(innerWidth-2*t-2*t)+2*t,o=Math.random()*(innerHeight-2*t-2*t)+2*t,s=.4*Math.random()-.2,a=.4*Math.random()-.2;particlesArray.push(new Particle(i,o,s,a,t,"rgba(200, 210, 255, 0.8)"))}}
        function connect(){let t=1;for(let e=0;e<particlesArray.length;e++)for(let i=e;i<particlesArray.length;i++){const o=(particlesArray[e].x-particlesArray[i].x)*(particlesArray[e].x-particlesArray[i].x)+(particlesArray[e].y-particlesArray[i].y)*(particlesArray[e].y-particlesArray[i].y);o<canvas.width/7*(canvas.height/7)&&(t=1-o/2e4,ctx.strokeStyle=`rgba(180, 190, 255, ${t})`,ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(particlesArray[e].x,particlesArray[e].y),ctx.lineTo(particlesArray[i].x,particlesArray[i].y),ctx.stroke())}}
        function animate(){requestAnimationFrame(animate),ctx.clearRect(0,0,innerWidth,innerHeight);for(let t=0;t<particlesArray.length;t++)particlesArray[t].update();connect()}
        window.addEventListener("resize",()=>{canvas.width=innerWidth,canvas.height=innerHeight,init(); updateStepDisplay(); }),init(),animate();

        // --- 圖片預加載邏輯 ---
        function preloadImages(urls) {
            urls.forEach(url => {
                const img = new Image();
                img.src = url;
            });
        }

        // --- 頁面切換與教學引導邏輯 ---
        const startBtn = document.getElementById('start-btn');
        const homeScreen = document.getElementById('home-screen');
        const tutorialScreen = document.getElementById('tutorial-screen');
        const tutorialBgImg = document.getElementById('tutorial-bg-img');
        const externalSiteIframe = document.getElementById('external-site-iframe');
        const tutorialOverlay = document.getElementById('tutorial-overlay');
        const tutorialHighlight = document.getElementById('tutorial-highlight');
        const tutorialText = document.getElementById('tutorial-text');
        const nextPageButton = document.querySelector('.next-page-button');

        // 在腳本開始時就呼叫預加載函式
        preloadImages(['page1.jpg', 'page2.jpg', 'page3.jpg', 'page4.jpg', 'dry-logo.png']);

        // ==================================================================
        // ======================= ✅ 正確的物件結構 =======================
        // ==================================================================
        const tutorialSteps = [
            {
                background: 'page1.jpg',
                highlight: { top: '25.0%', left: '15.9%', width: '7.6%', height: '6.2%', borderRadius: '8px' },
                text: {
                    content: `<h3>步驟 1：選擇縣市</h3><p>首先，從這裡的下拉選單中，選擇您想查詢水情的縣市。</p>`,
                    maxWidth: '350px'
                },
                textPosition: 'right',
                textOffset: 20
            },
            {
                background: 'page2.jpg',
                highlight: { top: '8.7%', left: '59.2%', width: '10.3%', height: '28.1%', borderRadius: '8px' },
                text: {
                    content: `<h3>步驟 2：防災快訊</h3><p>這裡是「防災快訊」區，點擊可查看重要的警示資訊，如水庫放水、高溫警報或停水通知。</p>`,
                    maxWidth: '300px'
                },
                textPosition: 'left'
            },
            {
                background: 'page3.jpg',
                highlight: { top: '9.1%', left: '65.3%', width: '10.3%', height: '47.1%', borderRadius: '8px' },
                text: {
                    content: `<h3>步驟 3：警戒資訊</h3><p>在「警戒資訊」中，您可以查詢各種警戒等級。接下來，我們將載入真實網站進行互動教學。</p>`,
                    maxWidth: '300px'
                },
                textPosition: 'left'
            },
            {
                background: 'page4.jpg',
                highlight: { top: '6.9%', left: '70.7%', width: '7%', height: '5%', borderRadius: '8px' },
                text: {
                    content: `<h3>步驟 4-1：請觀察監控資訊</h3><p>步驟一：請<span class="text-highlight">點擊</span>高亮處的「<b>監控資訊</b>」</p>`,
                    maxWidth: '450px'
                },
                isInteractive: true,
                textPosition: 'left'
            },
            {
                background: 'page4.jpg',
                highlight: { top: '28.9%', left: '71.5%', width: '10%', height: '6%', borderRadius: '8px' },
                text: {
                    content: `<h3>步驟 4-2：選擇項目</h3><p>步驟二：請從選單中<span class="text-highlight">點擊</span>「<b>水庫水情</b>」 <br>⭐請留意：之後的問卷將詢問 <span class="text-highlight">石門水庫的有效庫容量</span>，請您稍後在相關頁面中觀察並記下</p>`,
                    maxWidth: '400px'
                },
                isInteractive: true,
                textPosition: 'left'
            },
            {
                useIframe: true,
                // ✨ 新增 highlightTarget，值為「下一頁」按鈕的 CSS 選擇器
                highlightTarget: '.next-page-button', 
                text: {
                    content: `<h3>教學結束</h3><p>若您完成上述步驟，請點擊高亮處的「下一頁」按鈕，開始下一階段的情境挑戰遊戲。</p>`,
                    maxWidth: '350px'
                },
                // ✨ 現在我們可以為它設定智慧型定位了！
                textPosition: 'top', 
                isInteractive: true // 讓高亮框可以被點擊
            }
        ];

        let currentStep = -1;

        // ==================================================================
        // ======================= ✅ 修正後的函數 =========================
        // ==================================================================
        function updateStepDisplay() {
    if (currentStep < 0 || currentStep >= tutorialSteps.length) return;
    const step = tutorialSteps[currentStep];

    // 1. 更新文字內容 (邏輯不變)
    let smallText = '';
    if (!step.isInteractive) {
        smallText = step.text.content.includes("教學結束")
            ? '<small>請點擊右下角按鈕開始模擬。</small>'
            : '<small>點擊畫面任意處繼續...</small>';
    }
    tutorialText.innerHTML = `${step.text.content}${smallText}`;
    tutorialText.style.maxWidth = step.text.maxWidth || 'auto';

    // ✨ [新增] 處理 highlightTarget 的邏輯
    if (step.highlightTarget) {
        const targetElement = document.querySelector(step.highlightTarget);
        if (targetElement) {
            const rect = targetElement.getBoundingClientRect();
            const padding = 5; // 給高亮框一點呼吸空間

            // 直接用讀取到的元素位置來設定 highlight
            tutorialHighlight.style.top = `${rect.top - padding}px`;
            tutorialHighlight.style.left = `${rect.left - padding}px`;
            tutorialHighlight.style.width = `${rect.width + (padding * 2)}px`;
            tutorialHighlight.style.height = `${rect.height + (padding * 2)}px`;
            // 讓高亮框跟按鈕一樣圓
            tutorialHighlight.style.borderRadius = '50px'; 
            
            // ✨ 讓文字框定位邏輯也能用於 target 模式
            setTimeout(() => {
                const textEl = tutorialText;
                const textRect = textEl.getBoundingClientRect();
                const gap = step.textOffset || 15;
                const hTop = rect.top - padding;
                const hLeft = rect.left - padding;
                const hWidth = rect.width + (padding * 2);
                const hHeight = rect.height + (padding * 2);

                let newTextTop = 0, newTextLeft = 0;
                
                switch (step.textPosition) {
                    case 'top':
                        newTextTop = hTop - textRect.height - gap;
                        newTextLeft = hLeft + hWidth / 2 - textRect.width / 2;
                        break;
                    case 'left':
                        newTextTop = hTop + hHeight / 2 - textRect.height / 2;
                        newTextLeft = hLeft - textRect.width - gap;
                        break;
                    // 可以根據需要添加 'right', 'bottom'
                    default:
                        newTextTop = hTop - textRect.height - gap;
                        newTextLeft = hLeft + hWidth / 2 - textRect.width / 2;
                        break;
                }

                // 邊界檢查 (邏輯不變)
                if (newTextTop < gap) newTextTop = gap;
                if (newTextTop + textRect.height > window.innerHeight - gap) newTextTop = window.innerHeight - textRect.height - gap;
                if (newTextLeft < gap) newTextLeft = gap;
                if (newTextLeft + textRect.width > window.innerWidth - gap) newTextLeft = window.innerWidth - textRect.width - gap;

                textEl.style.top = `${newTextTop}px`;
                textEl.style.left = `${newTextLeft}px`;
            }, 0);
        }
        return; // 處理完 target 後就結束，不執行後續的 positioner
    }


    // 2. 定位器函數 (處理圖片背景，邏輯不變)
    const positioner = (imgWidth, imgHeight) => {
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const viewportRatio = viewportWidth / viewportHeight;
        const imageRatio = imgWidth / imgHeight;

        let renderedWidth, renderedHeight, offsetX, offsetY;

        if (imageRatio > viewportRatio) {
            renderedWidth = viewportWidth;
            renderedHeight = renderedWidth / imageRatio;
            offsetX = 0;
            offsetY = (viewportHeight - renderedHeight) / 2;
        } else {
            renderedHeight = viewportHeight;
            renderedWidth = renderedHeight * imageRatio;
            offsetY = 0;
            offsetX = (viewportWidth - renderedWidth) / 2;
        }

        const h = step.highlight;
        const hTop = offsetY + (parseFloat(h.top) / 100) * renderedHeight;
        const hLeft = offsetX + (parseFloat(h.left) / 100) * renderedWidth;
        const hWidth = (parseFloat(h.width) / 100) * renderedWidth;
        const hHeight = (parseFloat(h.height) / 100) * renderedHeight;

        tutorialHighlight.style.top = `${hTop}px`;
        tutorialHighlight.style.left = `${hLeft}px`;
        tutorialHighlight.style.width = `${hWidth}px`;
        tutorialHighlight.style.height = `${hHeight}px`;
        tutorialHighlight.style.borderRadius = h.borderRadius;

        setTimeout(() => {
            const textEl = tutorialText;
            const textRect = textEl.getBoundingClientRect();
            const gap = step.textOffset || 15;
            let newTextTop = 0, newTextLeft = 0;

            switch (step.textPosition) {
                case 'top':
                    newTextTop = hTop - textRect.height - gap;
                    newTextLeft = hLeft + hWidth / 2 - textRect.width / 2;
                    break;
                case 'right':
                    newTextTop = hTop + hHeight / 2 - textRect.height / 2;
                    newTextLeft = hLeft + hWidth + gap;
                    break;
                case 'left':
                    newTextTop = hTop + hHeight / 2 - textRect.height / 2;
                    newTextLeft = hLeft - textRect.width - gap;
                    break;
                case 'bottom':
                default:
                    newTextTop = hTop + hHeight + gap;
                    newTextLeft = hLeft + hWidth / 2 - textRect.width / 2;
                    break;
            }

            if (newTextTop < gap) newTextTop = gap;
            if (newTextTop + textRect.height > viewportHeight - gap) newTextTop = viewportHeight - textRect.height - gap;
            if (newTextLeft < gap) newTextLeft = gap;
            if (newTextLeft + textRect.width > viewportWidth - gap) newTextLeft = viewportWidth - textRect.width - gap;

            textEl.style.top = `${newTextTop}px`;
            textEl.style.left = `${newTextLeft}px`;
        }, 0);
        };

        // 根據步驟類型執行 (這裡的邏輯需要簡化)
        if (step.useIframe && !step.highlightTarget) {
            // 保留給未來可能出現的、沒有 target 的 iframe 步驟
            Object.assign(tutorialHighlight.style, step.highlight);
            tutorialText.style.top = step.text.top;
            tutorialText.style.left = step.text.left;
        } else {
            const img = new Image();
            img.onload = function() {
                positioner(this.width, this.height);
            };
            img.src = step.background;
        }
    }

        function showStep(stepIndex) {
            if (stepIndex >= tutorialSteps.length) {
                endTutorial();
                return;
            }
            currentStep = stepIndex;
            const step = tutorialSteps[currentStep];

            if (step.useIframe) {
                tutorialBgImg.style.display = 'none';
                externalSiteIframe.style.display = 'block';
            } else {
                externalSiteIframe.style.display = 'none';
                tutorialBgImg.style.display = 'block';
                // 預加載圖片
                const newImg = new Image();
                newImg.src = step.background;
                newImg.onload = () => {
                    const newSrc = new URL(step.background, window.location.href).href;
                    if (tutorialBgImg.src !== newSrc) {
                        tutorialBgImg.style.opacity = 0;
                        setTimeout(() => {
                            tutorialBgImg.src = newSrc;
                            tutorialBgImg.style.opacity = 1;
                        }, 300);
                    }
                }
            }

            updateStepDisplay();

            tutorialOverlay.style.pointerEvents = step.isInteractive ? 'none' : 'auto';
            tutorialHighlight.style.pointerEvents = step.isInteractive ? 'auto' : 'none';
        }

        function startTutorial() {
            document.body.classList.add('tutorial-active');
            homeScreen.classList.remove('active');
            tutorialScreen.classList.add('active');

            externalSiteIframe.src = 'https://fhy.wra.gov.tw/fhyv2/';

            setTimeout(() => {
                tutorialOverlay.classList.add('active');
                showStep(0);
            }, 500);
        }

        function endTutorial() {
            document.body.classList.remove('tutorial-active');
            tutorialOverlay.classList.remove('active');
            nextPageButton.style.boxShadow = '0 0 20px 5px #f39c12';
            nextPageButton.style.transform = 'scale(1.1)';
        }
        
        // 圖片預加載函數
        function preloadTutorialImages() {
            tutorialSteps.forEach(step => {
                if (step.background) {
                    const img = new Image();
                    img.src = step.background;
                }
            });
        }

        startBtn.addEventListener('click', startTutorial);

        tutorialOverlay.addEventListener('click', () => {
            if (currentStep > -1 && !tutorialSteps[currentStep].isInteractive) {
                showStep(currentStep + 1);
            }
        });

        tutorialHighlight.addEventListener('click', (e) => {
            if (currentStep > -1 && tutorialSteps[currentStep].isInteractive) {
                e.stopPropagation();
                showStep(currentStep + 1);
            }
        });
        
        // 監聽視窗大小變化時，重新定位教學元素
        window.addEventListener('resize', () => {
            if (currentStep > -1) {
                updateStepDisplay();
            }
        });

        // 頁面載入時就預加載圖片
        preloadTutorialImages();

    </script>
</body>
    </script>
</body>
</html>