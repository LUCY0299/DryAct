<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水資源永續挑戰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 基本設定 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden;
            background-color: #0b132b;
        }

        /* --- 背景層 --- */
        .background-gradient {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(-45deg, #0b132b, #1c2541, #3a506b, #5bc0be);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: 1;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
        }

        /* --- 內容層 --- */
        .screen {
            width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center; text-align: center; color: #ffffff;
            position: absolute; top: 0; left: 0;
            opacity: 0; visibility: hidden;
            transition: opacity 0.8s ease, visibility 0.8s ease;
            z-index: 3;
        }
        .screen.active { opacity: 1; visibility: visible; }
        #home-screen { flex-direction: column; }
        .logo {
            width: 180px; height: 180px; margin-bottom: 2rem;
            animation: float 4s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(91, 192, 190, 0.5));
            border-radius: 50%; object-fit: cover;
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0px); } }
        
        h1 { font-size: 2.8rem; text-shadow: 0 0 10px rgba(0, 0, 0, 0.5); margin-bottom: 1rem; font-weight: 700; }
        p.subtitle { font-size: 1.2rem; color: #cdd4e4; margin-bottom: 2.5rem; }

        .start-button {
            background-color: #5bc0be; color: #0b132b; border: none; padding: 15px 40px;
            font-size: 1.2rem; font-weight: 700; border-radius: 50px; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(91, 192, 190, 0.3); letter-spacing: 1px;
        }
        .start-button:hover { transform: translateY(-4px) scale(1.05); box-shadow: 0 8px 25px rgba(91, 192, 190, 0.5); }
        
        #tutorial-screen {
            /* Keep original background-color for non-iframe steps */
            background-color: #f0f2f5; 
        }
        #tutorial-bg-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        
        .next-page-button {
            position: fixed; bottom: 30px; right: 30px; background-color: #e67e22; color: white;
            padding: 12px 25px; border-radius: 50px; text-decoration: none; font-size: 1.1rem;
            font-weight: 500; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); transition: all 0.3s ease;
            z-index: 1000;
        }
        .next-page-button:hover { background-color: #d35400; transform: scale(1.05); }

        /* --- 教學引導層樣式 --- */
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1500;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #tutorial-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #tutorial-highlight {
            position: absolute;
            border: 3px solid #e74c3c;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(11, 19, 43, 0.85);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #tutorial-text {
            position: absolute;
            background-color: rgba(44, 62, 80, 0.95);
            color: #ecf0f1;
            padding: 20px 25px;
            border-radius: 10px;
            border: 1px solid #7f8c8d;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            line-height: 1.7;
            font-size: 1.1rem;
        }
        #tutorial-text h3 {
            margin: 0 0 10px 0;
            color: #5bc0be;
            font-size: 1.4rem;
        }
        #tutorial-text p {
            margin: 0 0 15px 0;
        }
        #tutorial-text small {
            color: #bdc3c7;
            font-style: italic;
        }
        .text-highlight {
            background-color: #f39c12;
            color: #0b132b;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2.2rem; }
            p.subtitle { font-size: 1rem; }
            .logo { width: 140px; height: 140px; }
            .start-button { padding: 12px 30px; font-size: 1rem;}
            .next-page-button { bottom: 20px; right: 20px; padding: 10px 20px; font-size: 1rem;}
            #tutorial-text { font-size: 1rem; padding: 15px 20px;}
            #tutorial-text h3 { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(11, 19, 43, 0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; text-align: left; color: #ecf0f1; padding: 20px; box-sizing: border-box;" id="welcome-statement">
        <div style="max-width: 800px; background-color: #1c2541; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); border: 1px solid #3a506b;">
            <h2 style="color: #5bc0be; font-size: 1.8em; margin-top: 0; text-align: center;">歡迎參與「數位平台設計對乾旱風險感知」學術研究</h2>
            <p style="font-size: 1.1em; line-height: 1.7;">您好！感謝您撥冗參與本次研究。本研究旨在探討數位共創平台的設計（如資訊呈現、互動方式）如何影響使用者對於乾旱風險的感知、對相關政策的認同，以及調高水費來因應乾旱的意願。</p>
            <p style="font-size: 1.1em; line-height: 1.7;">在接下來的體驗中，您將會依序完成以下三個環節：</p>
            <ol style="font-size: 1.1em; line-height: 1.8; padding-left: 25px;">
                <li><strong>前導教學：</strong>首先，我們會引導您熟悉水利署防災資訊網的操作，學習如何查詢即時的水庫水情資訊。</li>
                <li><strong>情境模擬挑戰：</strong>接著，您將進入一個「乾旱風險情境模擬器」。在此互動遊戲中，您的每個決策都將影響虛擬社區的水庫存量與您的節水積分。</li>
                <li><strong>研究問卷填寫：</strong>完成模擬挑戰後，系統將引導您填寫一份學術問卷，以收集您對於本次體驗的回饋與看法。</li>
            </ol>
            <p style="font-size: 1.1em; line-height: 1.7;">本問卷採匿名方式進行，所有資料僅供學術分析之用，請您放心填答。您的寶貴意見將是本研究成功的關鍵，並有助於未來開發更有效的數位溝通平台。</p>
            <div style="text-align: center; margin-top: 25px;">
                <button onclick="document.getElementById('welcome-statement').style.display='none';" style="background-color: #e67e22; color: white; border: none; padding: 12px 30px; font-size: 1.1em; font-weight: 700; border-radius: 50px; cursor: pointer; transition: all 0.3s ease;">我已了解，開始體驗</button>
            </div>
        </div>
    </div>

    <!-- 背景層 -->
    <div class="background-gradient"></div>
    <canvas id="particle-canvas"></canvas>

    <!-- 內容層 -->
    <div id="home-screen" class="screen active">
        <img src="dry-logo.png" alt="水資源 Logo" class="logo">
        <h1>第一階段：水資源永續挑戰</h1>
        <p class="subtitle">了解水情，學習節水，應對未來的乾旱風險</p>
        <button id="start-btn" class="start-button">開始挑戰</button>
    </div>

    <!-- 教學引導畫面 -->
    <div id="tutorial-screen" class="screen">
        <img id="tutorial-bg-img" src="" alt="防災資訊網教學背景">
        <!-- 移除 iframe 的 display:none 樣式，透過 JS 控制 -->
        <iframe id="external-site-iframe" style="width:100%; height:100%; border:none; position:absolute; top:0; left:0; z-index: 5;"></iframe>
        <a href="drought_simulator.html" class="next-page-button">下一頁 &raquo;</a>
    </div>

    <!-- 教學引導層 -->
    <div id="tutorial-overlay">
        <div id="tutorial-highlight"></div>
        <div id="tutorial-text"></div>
    </div>

    <script>
        // --- 粒子動畫邏輯 (保持不變) ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;
        class Particle{constructor(t,e,i,o,s,a){this.x=t,this.y=e,this.directionX=i,this.directionY=o,this.size=s,this.color=a}draw(){ctx.beginPath(),ctx.arc(this.x,this.y,this.size,0,2*Math.PI,!1),ctx.fillStyle=this.color,ctx.fill()}update(){this.x>canvas.width||this.x<0?this.directionX=-this.directionX:void 0,this.y>canvas.height||this.y<0?this.directionY=-this.directionY:void 0,this.x+=this.directionX,this.y+=this.directionY,this.draw()}}
        function init(){particlesArray=[];const t=(canvas.height*canvas.width)/9e3;for(let e=0;e<t;e++){const t=2*Math.random()+1,i=Math.random()*(innerWidth-2*t-2*t)+2*t,o=Math.random()*(innerHeight-2*t-2*t)+2*t,s=.4*Math.random()-.2,a=.4*Math.random()-.2;particlesArray.push(new Particle(i,o,s,a,t,"rgba(200, 210, 255, 0.8)"))}}
        function connect(){let t=1;for(let e=0;e<particlesArray.length;e++)for(let i=e;i<particlesArray.length;i++){const o=(particlesArray[e].x-particlesArray[i].x)*(particlesArray[e].x-particlesArray[i].x)+(particlesArray[e].y-particlesArray[i].y)*(particlesArray[e].y-particlesArray[i].y);o<canvas.width/7*(canvas.height/7)&&(t=1-o/2e4,ctx.strokeStyle=`rgba(180, 190, 255, ${t})`,ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(particlesArray[e].x,particlesArray[e].y),ctx.lineTo(particlesArray[i].x,particlesArray[i].y),ctx.stroke())}}
        function animate(){requestAnimationFrame(animate),ctx.clearRect(0,0,innerWidth,innerHeight);for(let t=0;t<particlesArray.length;t++)particlesArray[t].update();connect()}
        window.addEventListener("resize",()=>{canvas.width=innerWidth,canvas.height=innerHeight,init()}),init(),animate();


        // --- 頁面切換與教學引導邏輯 ---
        const startBtn = document.getElementById('start-btn');
        const homeScreen = document.getElementById('home-screen');
        const tutorialScreen = document.getElementById('tutorial-screen');
        const tutorialBgImg = document.getElementById('tutorial-bg-img');
        const externalSiteIframe = document.getElementById('external-site-iframe');
        const tutorialOverlay = document.getElementById('tutorial-overlay');
        const tutorialHighlight = document.getElementById('tutorial-highlight');
        const tutorialText = document.getElementById('tutorial-text');
        const nextPageButton = document.querySelector('.next-page-button');

        const tutorialSteps = [
            {
                background: 'page1.jpg',
                highlight: { top: '25.0%', left: '15.9%', width: '7.6%', height: '6.2%', borderRadius: '8px' },
                text: { top: '35%', left: '18%', maxWidth: '350px' },
                content: `<h3>步驟 1：選擇縣市</h3><p>首先，從這裡的下拉選單中，選擇您想查詢水情的縣市。</p>`
            },
            {
                background: 'page2.jpg',
                highlight: { top: '8.7%', left: '59.2%', width: '10.3%', height: '28.1%', borderRadius: '8px' },
                text: { top: '26.2%', left: '28.1%', maxWidth: '300px' },
                content: `<h3>步驟 2：防災快訊</h3><p>這裡是「防災快訊」區，點擊可查看重要的警示資訊，如水庫放水、高溫警報或停水通知。</p>`
            },
            {
                background: 'page3.jpg',
                highlight: { top: '9.1%', left: '65.3%', width: '10.3%', height: '47.1%', borderRadius: '8px' },
                text: { top: '26.2%', left: '34.1%', maxWidth: '300px' },
                content: `<h3>步驟 3：警戒資訊</h3><p>在「警戒資訊」中，您可以查詢各種警戒等級。接下來，我們將載入真實網站進行互動教學。</p>`
            },
            {
                useIframe: true,
                highlight: { top: '8.9%', left: '72.7%', width: '7%', height: '5%', borderRadius: '8px' },
                text: { top: '18%', left: '55%', maxWidth: '450px' },
                content: `<h3>步驟 4-1：請觀察監控資訊</h3><p>請<span class="text-highlight">雙擊</span>高亮處的「<b>監控資訊</b>」</p>`,
                isInteractive: true 
            },
            {
                useIframe: true,
                highlight: { top: '30.9%', left: '73.5%', width: '10%', height: '6%', borderRadius: '8px' },
                text: { top: '30%', left: '35%', maxWidth: '500px' },
                content: `<h3>步驟 4-2：選擇項目</h3><p>做得好！現在請從選單中<span class="text-highlight">點擊</span>「<b>水庫水情</b>」 <br>⭐請留意：之後的問卷將詢問 <span class="text-highlight">石門水庫的有效蓄水量</span>，請您稍後在相關頁面中觀察並記下</p>`,
                isInteractive: true 
            },
            {
                useIframe: true,
                highlight: { top: 'calc(100% - 76px)', left: 'calc(100% - 165px)', width: '145px', height: '48px', borderRadius: '50px' },
                text: { top: '60%', left: '53%', maxWidth: '350px' },
                content: `<h3>教學結束</h3><p>您已學會如何查找即時水情！點擊畫面任意處，然後點擊右下角的「下一頁」按鈕開始下一階段情境挑戰遊戲。</p>`,
                isInteractive: false
            }
        ];

        let currentStep = -1;

        function showStep(stepIndex) {
            if (stepIndex >= tutorialSteps.length) {
                endTutorial();
                return;
            }

            const step = tutorialSteps[stepIndex];
            
            if (step.useIframe) {
                // 如果是 iframe 步驟，顯示 iframe 並隱藏背景圖片
                tutorialBgImg.style.display = 'none';
                externalSiteIframe.style.display = 'block'; // 顯示 iframe
            } else {
                // 如果是圖片步驟，顯示背景圖片並隱藏 iframe
                externalSiteIframe.style.display = 'none'; // 隱藏 iframe
                tutorialBgImg.style.display = 'block';
                tutorialBgImg.style.opacity = 0;
                setTimeout(() => {
                    tutorialBgImg.src = step.background;
                    tutorialBgImg.style.opacity = 1;
                }, 300);
            }
            
            showStepContent(step);
        }

        function showStepContent(step) {
            tutorialHighlight.style.top = step.highlight.top;
            tutorialHighlight.style.left = step.highlight.left;
            tutorialHighlight.style.width = step.highlight.width;
            tutorialHighlight.style.height = step.highlight.height;
            tutorialHighlight.style.borderRadius = step.highlight.borderRadius;
            
            tutorialText.style.top = step.text.top;
            tutorialText.style.left = step.text.left;
            tutorialText.style.maxWidth = step.text.maxWidth || 'auto';
            
            let smallText = '';
            if (!step.isInteractive) {
                smallText = step.content.includes("教學結束") 
                    ? '<small>請點擊右下角按鈕開始模擬。</small>' 
                    : '<small>點擊畫面任意處繼續...</small>';
            }
            tutorialText.innerHTML = `${step.content}${smallText}`;

            tutorialOverlay.style.pointerEvents = step.isInteractive ? 'none' : 'auto';
            // 讓 tutorialHighlight 在步驟 4-1 時能夠接收 dblclick 事件，同時避免 click 事件
            // 對於其他 interactive 步驟，仍然響應 click
            tutorialHighlight.style.pointerEvents = step.isInteractive ? 'auto' : 'none';
        }
        
        function startTutorial() {
            homeScreen.classList.remove('active');
            tutorialScreen.classList.add('active');
            
            // 在教學開始時就預先載入 iframe 的內容，使其在背景開始載入
            externalSiteIframe.src = 'https://fhy.wra.gov.tw/fhyv2/';
            // 初始時 iframe 仍為隱藏 (display: none)，直到需要顯示時才切換

            setTimeout(() => {
                tutorialOverlay.classList.add('active');
                currentStep = 0;
                showStep(currentStep);
            }, 500);
        }

        function endTutorial() {
            tutorialOverlay.classList.remove('active');
            nextPageButton.style.boxShadow = '0 0 20px 5px #f39c12';
            nextPageButton.style.transform = 'scale(1.1)';
        }

        startBtn.addEventListener('click', startTutorial);

        tutorialOverlay.addEventListener('click', () => {
            if (currentStep > -1 && !tutorialSteps[currentStep].isInteractive) {
                currentStep++;
                showStep(currentStep);
            }
        });

        // 監聽單擊事件：如果當前步驟是 4-1 (currentStep === 3)，則不執行任何操作
        tutorialHighlight.addEventListener('click', (e) => {
            if (currentStep > -1 && tutorialSteps[currentStep].isInteractive) {
                if (currentStep === 3) { // 步驟 4-1 需要雙擊
                    e.stopPropagation();
                    return; // 阻止單擊在此步驟時跳轉
                }
                e.stopPropagation();
                currentStep++;
                showStep(currentStep);
            }
        });

        // 監聽雙擊事件：如果當前步驟是 4-1 (currentStep === 3)，則執行跳轉
        tutorialHighlight.addEventListener('dblclick', (e) => {
            if (currentStep === 3) { // 僅在步驟 4-1 時響應雙擊
                e.stopPropagation();
                currentStep++;
                showStep(currentStep);
            }
        });

        // 僅用於開發時獲取點擊座標，正式環境可移除
        document.body.addEventListener('mousedown', function(e) {
            if (!e.target.closest('#tutorial-overlay')) {
                const xPercent = (e.clientX / window.innerWidth * 100).toFixed(1);
                const yPercent = (e.clientY / window.innerHeight * 100).toFixed(1);
                console.log(`點擊座標: { top: '${yPercent}%', left: '${xPercent}%' }`);
            }
        });
    </script>
</body>
</html>